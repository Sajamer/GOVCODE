model Framework {
  id   String @id @default(cuid())
  name String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  attributes  FrameworkAttribute[]
  auditCycles AuditCycle[]
}

model FrameworkAttribute {
  id    String  @id @default(cuid())
  name  String
  value String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  frameworkId String
  framework   Framework @relation(fields: [frameworkId], references: [id], onDelete: Cascade)

  parentId String?
  parent   FrameworkAttribute?  @relation("AttributeHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children FrameworkAttribute[] @relation("AttributeHierarchy")

  rowIndex Int @default(0)
  colIndex Int @default(0)

  auditDetails AuditDetails[]

  @@index([frameworkId])
  @@index([parentId])
}

model AuditDetails {
  id String @id @default(cuid())

  frameworkAttributeId String
  frameworkAttribute   FrameworkAttribute @relation(fields: [frameworkAttributeId], references: [id], onDelete: Cascade)

  auditCycleId Int
  auditCycle   AuditCycle @relation(fields: [auditCycleId], references: [id], onDelete: Cascade)

  auditBy String?
  auditor User?   @relation(fields: [auditBy], references: [id])

  statusId Int
  status   auditStatus @relation(fields: [statusId], references: [id])

  attachmentUrl  String? @db.Text
  attachmentName String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([frameworkAttributeId, auditCycleId]) // Ensure one audit detail per attribute per cycle
  @@index([frameworkAttributeId])
  @@index([auditCycleId])
  @@index([auditBy])
}

model AuditCycle {
  id          Int       @id @default(autoincrement())
  name        String
  description String?   @db.Text
  startDate   DateTime
  endDate     DateTime?
  comment     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  auditBy String?
  user    User?   @relation(fields: [auditBy], references: [id])

  statusId Int
  status   auditStatus @relation(fields: [statusId], references: [id])

  frameworkId String?
  framework   Framework? @relation(fields: [frameworkId], references: [id], onDelete: SetNull)

  auditDetails AuditDetails[]

  @@index([frameworkId])
}

model auditStatus {
  id   Int    @id @default(autoincrement())
  name String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  auditRules   auditRules[]
  auditCycles  AuditCycle[]
  auditDetails AuditDetails[]
}

model auditRules {
  id    Int    @id @default(autoincrement())
  label String
  color String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  statusId Int
  status   auditStatus @relation(fields: [statusId], references: [id], onDelete: Cascade)
}
